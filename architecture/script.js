let munObjData = {
	"Муниципальное образование «Боброво-Лявленское»":{
		"Филиал ГБУЗ «Приморская ЦРБ» ФАП «Кузьмино»":{
			"circles":[[64.384133, 40.952229]],
			"link":"objects/1. Боброво-Лявленское-/1 ФАП Кузьмино+.docx"
		},
		"ГБСУ АО «Трепузовский психоневрологический интернат»":{
			"circles":[[64.364541, 41.057305]],
			"coord":[[64.364541, 41.057305], [64.364222, 41.055939], [64.363499, 41.053911], [64.362841, 41.055481], [64.361703, 41.059022], [64.361836, 41.059599], [64.362404, 41.060254], [64.362905, 41.059904], [64.363384, 41.059266], [64.363324, 41.059022]],
			"links":"objects/1. Боброво-Лявленское-/2 Трепузовский интернат+.docx"
		},
		"Филиал ГБУЗ «Приморская ЦРБ» ФАП «Лявля»":{
			"circles":[[64.377379, 41.023105]],
			"links":"objects/1. Боброво-Лявленское-/3 ФАП Лявля+.docx"
		},
		"Врачебная амбулатория \"Боброво\"":{
			"circles":[[64.356268, 41.152880]],
			"links":"objects/1. Боброво-Лявленское-/4 Амбулатория Боброво+.docx"
		},
		"Филиал ГБУЗ «Приморская ЦРБ» ФАП «Косково»":{
			"circles":[[64.347224, 41.353134]],
			"links":"objects/1. Боброво-Лявленское-/5 ФАП Косково+.docx"
		},
		"МБОУ «Бобровская СШ» ":{
			"circles":[[64.355401, 41.159310], [64.355283, 41.159310], [64.355032, 41.159310], [64.354362, 41.158999], [64.355018, 41.160732]],
			"coord":[[64.355762, 41.159231], [64.355622, 41.159263], [64.355064, 41.159306], [64.354316, 41.158972], [64.354197, 41.160351], [64.355657, 41.161048]],
			"links":"objects/1. Боброво-Лявленское-/6 Бобровская СШ+.docx"
		},
		"МБОУ «Бобровская СОШ» филиал Лявленская начальная школа-детский сад ":{
			"circles":[[64.385939, 41.027266], [64.386150, 41.028843], [64.385347, 41.028103]],
			"coord":[[64.385971, 41.027266], [64.385888, 41.027244], [64.385340, 41.028001], [64.385389, 41.028693], [64.386213, 41.028886], [64.386255, 41.028586], [64.386252, 41.028280]],
			"links":"objects/1. Боброво-Лявленское-/7 Детский сад Лявля+.docx"
		},
		"Хоккейная площадка":{
			"circles":[[64.355419, 41.153510]],
			"coord":[[64.355472, 41.153518], [64.355058, 41.153390], [64.355024, 41.153449], [64.354995, 41.153888], [64.355028, 41.153980], [64.355430, 41.154114], [64.355467, 41.154065], [64.355505, 41.153588]],
			"links":"objects/1. Боброво-Лявленское-/8 Хоккейная площадка Боброво+.docx"
		},
		"Волебольная площадка":{
			"circles":[[64.384470, 41.023234]],
			"coord":[[64.384468, 41.023186], [64.384146, 41.023170], [64.384241, 41.023674], [64.384473, 41.023301]],
			"links":"objects/1. Боброво-Лявленское-/9 Волебольная площадка у ДК д. Новинки+.docx"
		},
		"Тренажерный зал":{
			"circles":[[64.384528, 41.023290]],
			"links":"objects/1. Боброво-Лявленское-/10 Тренажерный зал в ДК д. Новинки+.docx"
		}
	},
	"Муниципальное образование «Заостровское»":{
		"Филиал ГБУЗ «Приморская ЦРБ» «Заостровская участковая больница»":{
			"circles":[[64.480224, 40.507131]],
			"coord":[[64.480918, 40.504770], [64.480014, 40.505232], [64.480199, 40.507115], [64.480278, 40.507120], [64.480909, 40.506584], [64.480935, 40.506369], [64.481055, 40.506321]],
			"links":"objects/2. Заостровское/1. Заостровская больница+.docx"
		},
		"Филиал ГБУЗ «Приморская ЦРБ» ФАП «Луговой»":{
			"circles":[[64.510257, 40.433651]],
			"links":"objects/2. Заостровское/2. ФАП п. Луговой+.docx"
		},
		"МБОУ «Заостровская СШ» Структурное подразделение «Детский сад с. Заостровье»":{
			"circles":[[64.482480, 40.506837]],
			"coord":[[64.482429, 40.505271], [64.481802, 40.505545], [64.481894, 40.507106], [64.482459, 40.506966], [64.482503, 40.506741]],
			"links":"objects/2. Заостровское/3. Детский сад Заостровье+.docx"
		},
		"МБОУ «Заостровская СШ» (здание начальной школы)":{
			"circles":[[64.481427, 40.507465], [64.481360, 40.509455]],
			"coord":[[64.481624, 40.507605], [64.481114, 40.507293], [64.480909, 40.509171], [64.481411, 40.509461]],
			"links":"objects/2. Заостровское/4. Начальная школа. Заостровье+.docx"
		},
		"МБОУ «Заостровская СШ» ":{
			"circles":[[64.481534, 40.511470], [64.480783, 40.510091], [64.480150, 40.513867]],
			"coord":[[64.481519, 40.511516], [64.481023, 40.510158], [64.480641, 40.510062], [64.479472, 40.512253], [64.480067, 40.514099]],
			"links":"objects/2. Заостровское/5. Школа в д. Рикасово+.docx"
		},
		"Тренажерный зал":{
			"circles":[[64.484343, 40.506687]],
			"links":"objects/2. Заостровское/6. Тренажерный зал. Заостровье+.docx"
		}
	},
	"Муниципальное образование «Катунинское»":{
		"ГБУЗ АО «Приморская ЦРБ» Врачебная амбулатория «Катунино»":{
			"circles":[[64.389613, 40.625176]],
			"links":"objects/3. Катунинское/1 Амбулатория Катунино+.docx"
		},
		"Филиал ГБУЗ «Приморская ЦРБ» ФАП «Беломорье»":{
			"circles":[[64.292947, 40.892626]],
			"links":"objects/3. Катунинское/2 ФАП Беломорье+.docx"
		},
		"Учреждение «Базовый санаторий «Беломорье»":{
			"circles":[[64.292312, 40.888633], [64.293738, 40.890779], [64.294418, 40.892013]],
			"coord":[[64.295690, 40.886292], [64.294153, 40.886968], [64.292252, 40.888567], [64.294903, 40.892831], [64.295867, 40.889945], [64.296045, 40.887852]],
			"links":"objects/3. Катунинское/3 Санаторий Беломорье+.docx"
		},
		"МБОУ «Катунинская СШ»":{
			"circles":[[64.391430, 40.623908], [64.392214, 40.624422], [64.393272, 40.623210]],
			"coord":[[64.392795, 40.622148], [64.392503, 40.622127], [64.392233, 40.622749], [64.391523, 40.623479], [64.391430, 40.623908], [64.392749, 40.624785], [64.392935, 40.624863], [64.393118, 40.624838], [64.393095, 40.624082], [64.393124, 40.624063], [64.393110, 40.623884], [64.393217, 40.623843], [64.393272, 40.623210]],
			"links":"objects/3. Катунинское/4 Катунинская СШ_осн_школа+.docx"
		},
		"МБОУ «Катунинская СШ»":{
			"circles":[[64.388362, 40.630602]],
			"links":"objects/3. Катунинское/5 Катунинская СШ - начальная шк+.docx"
		},
		"Структурное подразделение «Детский сад п.Катунино» МБОУ «Катунинская СШ»":{
			"circles":[[64.389959, 40.624602]],
			"coord":[[64.390460, 40.624414], [64.390319, 40.624315], [64.390346, 40.623969], [64.390096, 40.623757], [64.389887, 40.625377], [64.390338, 40.625323]],
			"links":"objects/3. Катунинское/6 Детсад Катунино+.docx"
		},
		"Филиал «Детский сад д.Лахта» МБОУ «Катунинская СШ»":{
			"circles":[[64.394534, 40.617809], [64.394993, 40.618603]],
			"coord":[[64.395079, 40.617139], [64.394754, 40.617128], [64.394550, 40.617418], [64.394541, 40.617906], [64.394807, 40.618566], [64.395130, 40.618614], [64.395281, 40.618249], [64.395311, 40.617847]],
			"links":"objects/3. Катунинское/7 Детсад Лахта+.docx"
		},
		"МБУ ДО «Приморская детская школа искусств»":{
			"circles":[[64.389708, 40.624430]],
			"links":"objects/3. Катунинское/8 ДШИ+.docx"
		}
	},
	"Муниципальное образование «Лисестровское»":{
		"Филиал ГБУЗ АО «Приморская ЦРБ» ФАП «Лисестровское»":{
			"circles":[[64.464608, 40.638100]],
			"links":"objects/4. Лисестровское-/1. ФАП Лисестровское+.docx"
		},
		"Филиал ГБУЗ АО «Приморская ЦРБ» ФАП «Васьково»":{
			"circles":[[64.413765, 40.460864]],
			"links":"objects/4. Лисестровское-/2. ФАП Васьково+.docx"
		},
		"Филиал ГБУЗ АО «Приморская ЦРБ» ФАП «Ширшинский ЗВЕРОСОВХОЗ»":{
			"circles":[[64.410135, 40.741568], [64.410139, 40.742045], [64.409597, 40.741477]],
			"coord":[[64.410137, 40.741463], [64.409568, 40.741474], [64.409570, 40.742614], [64.410140, 40.742614]],
			"links":"objects/4. Лисестровское-/3. ФАП Ширшинский зверосовхоз+.docx"
		},
		"ГБСУ АО «Ширшинский психоневрологический интернат»":{
			"circles":[[64.413231, 40.753770], [64.413158, 40.755130]],
			"coord":[[64.414046, 40.753195], [64.414017, 40.753187], [64.412994, 40.753938], [64.413425, 40.756907], [64.414752, 40.755921], [64.414639, 40.755055], [64.414308, 40.755280]],
			"links":"objects/4. Лисестровское-/4. Ширшинский интернат+.docx"
		},
		"Филиал «Детский сад п.Ширшинский» МБОУ «Катунинская СШ»":{
			"circles":[[64.410135, 40.741568], [64.410139, 40.742045], [64.409597, 40.741477]],
			"coord":[[64.410137, 40.741463], [64.409568, 40.741474], [64.409570, 40.742614], [64.410140, 40.742614]],
			"links":"objects/4. Лисестровское-/5. Ширшинский детсад+.docx"
		},
		"МБОУ «Васьковская СШ» (основное здание)":{
			"circles":[[64.412150, 40.453559]],
			"links":"objects/4. Лисестровское-/6.1 Васьковская СШ_осн_зд+.docx"
		},
		"МБОУ «Васьковская СШ» (начальная школа)":{
			"circles":[[64.409850, 40.454958]],
			"links":"objects/4. Лисестровское-/6.2. Васьковская СШ_начальная шк+.docx"
		}
	},
	"Муниципальное образование «Островное»":{

	},
	"Муниципальное образование «Пертоминское»":{

	},
	"Муниципальное образование «Приморское»":{

	},
	"Муниципальное образование «Сельское поселение «Соловецкое»":{

	},
	"Муниципальное образование «Талажское»":{

	},
	"Муниципальное образование «Уемское»":{
		"ГБУЗ АО «Приморская ЦРБ» Уемская районная больница":{
			"circles":[[64.473565, 40.864479]],
			"link":"objects\\Уемское\\1 Уемская больница.docx"
		},
		"МБОУ «Уемская СШ»":{
			"circles":[[64.478826, 40.842030], [64.478238, 40.843591]],
			"coord":[[64.479041, 40.840856], [64.478520, 40.840166], [64.478226, 40.840209], [64.477522, 40.842922], [64.478358, 40.843720]],
			"link":"objects\\Уемское\\2 Уемская школа.docx"
		},
		"Филиал «Детская школа искусств п. Уемский» МБУ ДО «Приморская ДШИ»":{
			"circles":[[64.478826, 40.842030], [64.478238, 40.843591]],
			"coord":[[64.479041, 40.840856], [64.478520, 40.840166], [64.478226, 40.840209], [64.477522, 40.842922], [64.478358, 40.843720]],
			"link":"objects\\Уемское\\3 филиал Уемский ДШИ.docx"
		},
		"ГБСУ АО «Приморский СРЦН «Радуга»":{
			"circles":[[64.471922, 40.872014]],
			"coord":[[64.472672, 40.872432], [64.472184, 40.871381], [64.471665, 40.872652], [64.472154, 40.873698]],
			"link":"objects\\Уемское\\4 Центр Радуга.docx"
		},
		"Футбольная площадка":{
			"circles":[[64.474802, 40.863905]],
			"coord":[[64.475165, 40.863992], [64.474842, 40.863527], [64.474765, 40.863832], [64.475083, 40.864307]],
			"link":"objects\\Уемское\\5 Футбольная площадка Уемское.docx"
		},
		"МБОУ «Уемская СШ» Структурное подразделение «Детский сад п. Уемский»":{
			"circles":[[64.473155, 40.868829]],
			"coord":[[64.473766, 40.869864], [64.473766, 40.869864], [64.473176, 40.868780], [64.472884, 40.869478], [64.472967, 40.869633], [64.472861, 40.869864], [64.472590, 40.869671], [64.472384, 40.870159], [64.473007, 40.871554]],
			"link":"objects\\Уемское\\6 Детский сад Уемский.docx"
		},
		"Лыжный стадион им. В. С. Кузина":{
			"circles":[[64.462176, 40.943002]],
			"coord":[[64.462452, 40.943326], [64.462317, 40.943203], [64.462198, 40.942991], [64.462181, 40.942945], [64.462051, 40.941510], [64.460345, 40.939780], [64.459727, 40.944538], [64.460838, 40.949355], [64.462542, 40.949645]],
			"link":"objects\\Уемское\\7 Стадион. М. Корелы.docx"
		}
	}
}

ymaps.ready(init);

var mapCircle,
	circleCollection = {},
	pointCollection = {};

function init() {
	yMap = new ymaps.Map("map", {
		center: [64.543235, 40.537195],
		zoom: 13,
		type: 'yandex#hybrid'
	});

	circleCollection = new ymaps.GeoObjectCollection({}, {
    	fillColor: "#FF000025",
	  	strokeColor: "#FF0000",
	   	strokeWidth: 2
	});
}

function createSelect(selectElement, objectData, addData = false) {
	selectElement.html('');
	Object.keys(objectData).forEach(function (item){
		selectElement.append($('<li>').text(item));
	});
}

function closeList(listEl = $('.selectElement ul'), currentEl = $('.valueText')) {
	currentEl.children('img').css('transform', 'rotate(0)');
	listEl.css('display', 'none');
	currentEl.removeClass('active');
}

function openList(listEl, currentEl) {
	currentEl.children('img').css('transform', 'rotate(180deg)');
	listEl.css('display', 'block');
	currentEl.addClass('active');
}

createSelect($('#munForm ul'), munObjData);

$('.valueText').on('click', function() {
	closeList();
	let listEl = $(this).parent().children('ul')

	if ($(this).hasClass('active'))
		closeList(listEl, $(this));
	else
		openList(listEl, $(this));
});

$('#munForm').on('click', 'li', function() {
	createSelect($('#munObj ul'), munObjData[$(this).text()]);
	$('#munForm .valueText').children('span').text($(this).text());
	closeList();
});

$('#munObj').on('click', 'li', function() {
	circleCollection = new ymaps.GeoObjectCollection({}, {
		fillColor: "#FF000025",
		strokeColor: "#FF0000",
		strokeWidth: 2
	});


	pointCollection = new ymaps.GeoObjectCollection({
		properties: {
			iconContent: "Азербайджан"
		}
	}, {
			preset: 'islands#blackStretchyIcon'
	});

	$('#munObj .valueText').children('span').text($(this).text());
	closeList();

	$('#download').removeClass('disabled');
	$('#download').attr('href', munObjData[$('#munForm .valueText span').text()][$('#munObj .valueText span').text()].link);

	yMap.geoObjects.removeAll();

	if (munObjData[$('#munForm .valueText span').text()][$('#munObj .valueText span').text()].coord == undefined) {
		munObjData[$('#munForm .valueText span').text()][$('#munObj .valueText span').text()].circles.forEach(function(item) {
			circleCollection.add(new ymaps.Circle([item, 30]));
			pointCollection.add(new ymaps.Placemark(item, {
    			iconContent: "Вход"
    		}));
		});
	} else {
		munObjData[$('#munForm .valueText span').text()][$('#munObj .valueText span').text()].circles.forEach(function(item) {
			circleCollection.add(new ymaps.Circle([item, 30]));
			pointCollection.add(new ymaps.Placemark(item, {
    			iconContent: "Вход"
    		}));
		});
		circleCollection.add(new ymaps.Polygon([munObjData[$('#munForm .valueText span').text()][$('#munObj .valueText span').text()].coord]));
	}

	yMap.geoObjects.add(circleCollection).add(pointCollection);
	yMap.setBounds(circleCollection.getBounds(), {
		checkZoomRange:true
	}).then(function() {
		if (map.getZoom() > 10)
			map.setZoom(10);
	});
});

$(document).mouseup(function (e){
	var div = $("#munForm");
	if (!div.is(e.target)
	    && div.has(e.target).length === 0) {
		closeList();
	}
});

$(document).mouseup(function (e){
	var div = $("#munObj");
	if (!div.is(e.target)
	    && div.has(e.target).length === 0) {
		closeList();
	}
});

//Матан, геодезия, геометрия
//Оказалось, что в соотвествуии с действующим законодательством следубщий код не нужен. Но лучше оставлю.
/*
function resizePoly(arrCoord) {
	let lineCoordArray = [], bigPolyCoordLine = [], angleObj = [];

	arrCoord.forEach(function (item, i) {
		lineCoordArray.push(
			(i < arrCoord.length - 1) ?
			[item, arrCoord[i + 1]] :
			[item, arrCoord[0]]
		);
	});

	lineCoordArray.forEach(function(item) {
		angleObj.push({
			angle: getDirection(item, 30)[0],
			direction: getDirection(item, 30)[1],
			points: item
		});
	});

	angleObj.forEach(function(item, i) {
		if (i == angleObj.length - 1) {
			bigPolyCoordLine = bigPolyCoordLine.concat(roundAngle(item.points[1], item.direction, angleObj[0].direction, item.angle, angleObj[0].angle));
		} else {
			bigPolyCoordLine = bigPolyCoordLine.concat(roundAngle(item.points[1], item.direction, angleObj[i + 1].direction, item.angle, angleObj[i + 1].angle));
		}
	});

	bigPolyCoordLine = crossingLine(bigPolyCoordLine);

	mapPoly.geometry.setCoordinates([bigPolyCoordLine]);
}

function crossingLine(bigPolyCoordLine, i = 0) {
	for (i = 0; i < bigPolyCoordLine.length - 1; i++) {
		let x1 = Number(bigPolyCoordLine[i][0]),
			y1 = Number(bigPolyCoordLine[i][1]),
			x2 = Number(bigPolyCoordLine[i + 1][0]),
			y2 = Number(bigPolyCoordLine[i + 1][1]);

		for (let j = i + 2; j < bigPolyCoordLine.length - 1; j++) {
			let x3 = Number(bigPolyCoordLine[j][0]),
				y3 = Number(bigPolyCoordLine[j][1]),
				x4 = Number(bigPolyCoordLine[j + 1][0]),
				y4 = Number(bigPolyCoordLine[j + 1][1]);

			let d = ((x1 - x2) * (y4 - y3)) - ((y1 - y2) * (x4 - x3)),
				da = (((x1 - x3) * (y4 - y3)) - ((y1 - y3) * (x4 - x3))),
				db = (((x1 - x2) * (y1 - y3)) - ((y1 - y2) * (x1 - x3))),
				ta = da / d,
				tb = db / d,
				x, y;

			if (ta >= 0 && ta <= 1 && tb >= 0 && tb <= 1) {
				x = x1 + (ta * (x2 - x1));
				y = y1 + (ta * (y2 - y1));

				bigPolyCoordLine.splice(i, j - i + 1);
				bigPolyCoordLine.splice(i, 0, [x, y])

				crossingLine(bigPolyCoordLine, i)
			}
		}
	}
	return bigPolyCoordLine;
}

function getCenterLinePoint(twoPointsArray) {
	return [((twoPointsArray[0][0] + twoPointsArray[1][0]) / 2), ((twoPointsArray[0][1] + twoPointsArray[1][1]) / 2)];
}

function getAngle(twoPointArray) {
	let centerPoint, endPoint;

	if (twoPointArray[0][1] < twoPointArray[1][1]) {
		centerPoint = {
			x: twoPointArray[0][0],
			y: twoPointArray[0][1]
		}

		endPoint = {
			x: twoPointArray[1][0],
			y: twoPointArray[1][1]
		}
	} else {
		centerPoint = {
			x: twoPointArray[1][0],
			y: twoPointArray[1][1]
		}

		endPoint = {
			x: twoPointArray[0][0],
			y: twoPointArray[0][1]
		}
	}

	let distanceX = ymaps.coordSystem.geo.getDistance([centerPoint.x, centerPoint.y], [endPoint.x, centerPoint.y]),
		distanceY = ymaps.coordSystem.geo.getDistance([centerPoint.x, centerPoint.y], [centerPoint.x, endPoint.y]);

	if ((centerPoint.x < endPoint.x) && (centerPoint.y < endPoint.y))
		return Math.atan2(distanceY, distanceX) + (Math.PI / 2);

	if ((centerPoint.x > endPoint.x) && (centerPoint.y < endPoint.y))
		return (Math.PI / 2) - Math.atan2(distanceY, distanceX);
}

function getDirection(item, distance) {
	let centerLinePoint = getCenterLinePoint(item),
		direction = getAngle(item);

	if (mapPoly.geometry.contains(ymaps.coordSystem.geo.solveDirectProblem(centerLinePoint, [Math.cos(direction), Math.sin(direction)], 1).endPoint))
		return [direction, -distance];
	else
		return [direction, distance];
}

function roundAngle(centerPoint, directionStart, directionEnd, angleStart, angleEnd) {
	let roundPointsArray = [];

	if (directionStart == directionEnd) {
		for (let i = angleStart; i > angleEnd; i -= (Math.PI / 45)) {
			roundPointsArray.push(ymaps.coordSystem.geo.solveDirectProblem(centerPoint, [Math.cos(i), Math.sin(i)], directionStart).endPoint);
		}
	} else {
		for (let i = angleStart; i > 0; i -= (Math.PI / 45)) {
			roundPointsArray.push(ymaps.coordSystem.geo.solveDirectProblem(centerPoint, [Math.cos(i), Math.sin(i)], directionStart).endPoint);
		}
		for (let i = Math.PI; i > angleEnd; i -= (Math.PI / 45)) {
			roundPointsArray.push(ymaps.coordSystem.geo.solveDirectProblem(centerPoint, [Math.cos(i), Math.sin(i)], directionEnd).endPoint);
		}
	}

	return roundPointsArray;
}*/